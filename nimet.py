#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import csv
import os

def read_names(filename):
    with open(filename) as f:
        namedata = csv.reader(f, delimiter=";")
        next(namedata)  # ignore header
        return {line[0]: int(line[1].replace(u"\U000000A0", "")) for line in namedata}

def lue_sukunimet():
    with open("sukunimitilasto-2023-02-03-dvv/Nimet-Table 1.csv") as f:
        namedata = csv.reader(f, delimiter=";")
        next(namedata)  # ignore header
        return {line[0]: int(line[1].replace(u"\U000000A0", "")) for line in namedata}

#miesten_ekat = read_names("etunimitilasto-2023-02-03-dvv/Miehet ens-Table 1.csv")
miesten_nimet = read_names("etunimitilasto-2023-02-03-dvv/Miehet kaikki-Table 1.csv")
naisten_nimet = read_names("etunimitilasto-2023-02-03-dvv/Naiset kaikki-Table 1.csv")

#sukunimet = lue_sukunimet()
#sukunimietunimet = sorted([(nimi, lkm, sukunimet[nimi]) for nimi, lkm in miesten_ekat.items() if nimi in sukunimet and 5*lkm < sukunimet[nimi] and lkm > 50])
#for nimi, lkm, sukunimet in sukunimietunimet:
#    print(nimi, lkm, sukunimet)

nimet = {nimi: (miehet, nimi in naisten_nimet and naisten_nimet[nimi] or 0) for nimi, miehet in miesten_nimet.items()}

konsonantit = "bcdfghjklmnpqrstvwxz"

poissuljetut = set([
    "Aahil",
    "Aakke",
    "Aalto",
    "Aamon",
    "Aamunvalo",
    "Aanon",
    "Aapel",
    "Aapeli",
    "Aappi",
    "Aappo",
    "Aatami",
    "Aatovi",
    "Aatte",
    "Aatto",
    "Aattu",
    "Ahmat",
    "Ahmet",
    "Aiham",
    "Aiman",
    "Ajmal",
    "Akeem",
    "Akinpoika",
    "Akipekka",
    "Akito",
    "Akmeeli",
    "Akunpoika",
    "Alain",
    "Aleko",
    "Alieu",
    "Alija",
    "Alinpoika",
    "Alioune",
    "Allah",
    "Allal",
    "Allan",
    "Allani",
    "Allanti",
    "Allen",
    "Almin",
    "Alpha",
    "Alpiin",
    "Alpin",
    "Altan",
    "Altin",
    "Altti",
    "Alvian",
    "Alvin",
    "Amani",
    "Amanj",
    "Amanuel",
    "Amanullah",
    "Ameen",
    "Amiel",
    "Amiin",
    "Amine",
    "Anakin",
    "Anatol",
    "Anatole",
    "Anatoli",
    "Anatolii",
    "Anatolij",
    "Anian",
    "Anini",
    "Anjan",
    "Ankit",
    "Antamo",
    "Anthon",
    "Anthoni",
    "Anthonio",
    "Antoine",
    "Anton",
    "Antone",
    "Antoni",
    "Antonin",
    "Antonino",
    "Antonio",
    "Antte",
    "Antti",
    "Antto",
    "Antton",
    "Anttoni",
    "Anttonio",
    "Anttoo",
    "Anttooni",
    "Anttu",
    "António",
    "Apollo",
    "Apollon",
    "Atakan",
    "Atenpoika",
    "Atila",
    "Atilla",
    "Attila",
    "Aviel",
    "Eelia",
    "Eelian",
    "Eeliel",
    "Eelon",
    "Eelovi",
    "Eemel",
    "Eemeli",
    "Eemiel",
    "Eemil",
    "Eemili",
    "Eemin",
    "Eenok",
    "Eenokki",
    "Eetvi",
    "Eikka",
    "Eilon",
    "Eitan",
    "Eitel",
    "Ekene",
    "Elamin",
    "Eliah",
    "Eliahu",
    "Eliakim",
    "Eliam",
    "Elian",
    "Eliel",
    "Elija",
    "Elijah",
    "Elion",
    "Eliot",
    "Eliott",
    "Elián",
    "Eljakim",
    "Eljami",
    "Eljan",
    "Eljon",
    "Elliot",
    "Ellioth",
    "Elliott",
    "Elmin",
    "Elton",
    "Elvin",
    "Emanuel",
    "Emanuele",
    "Emeka",
    "Emenike",
    "Emiel",
    "Emile",
    "Emilian",
    "Emiliano",
    "Emilien",
    "Emilio",
    "Emmanouil",
    "Emmanuel",
    "Emmanuil",
    "Emmet",
    "Emmett",
    "Emppu",
    "Eniola",
    "Ennio",
    "Ethan",
    "Etienne",
    "Haakon",
    "Haiku",
    "Haile",
    "Hailu",
    "Haitham",
    "Hakan",
    "Hakeem",
    "Hakim",
    "Hakki",
    "Hakon",
    "Halil",
    "Halim",
    "Halit",
    "Halmat",
    "Halti",
    "Haluk",
    "Hamilton",
    "Hamit",
    "Hanno",
    "Hannu",
    "Hatem",
    "Hatim",
    "Haval",
    "Heath",
    "Heiki",
    "Heikka",
    "Heikki",
    "Heiko",
    "Heimo",
    "Heino",
    "Hekmat",
    "Heljo",
    "Helke",
    "Hellmuth",
    "Helmut",
    "Helmuth",
    "Hemen",
    "Hemin",
    "Hemmi",
    "Hemminki",
    "Hemmo",
    "Henkka",
    "Henno",
    "Henok",
    "Heppu",
    "Hikmet",
    "Hilal",
    "Hillel",
    "Hilmi",
    "Hjalte",
    "Huima",
    "Humam",
    "Huoti",
    "Huuko",
    "Iakov",
    "Ihanto",
    "Iikka",
    "Iikko",
    "Iippo",
    "Iivan",
    "Iivana",
    "Ikenna",
    "Ilhan",
    "Ilian",
    "Ilija",
    "Ilkka",
    "Illia",
    "Ilppo",
    "Imanuel",
    "Immanuel",
    "Ionel",
    "Ionut",
    "Italo",
    "Ivalo",
    "Ivanov",
    "Jaajo",
    "Jaakim",
    "Jaakkima",
    "Jaakko",
    "Jaako",
    "Jaakop",
    "Jaakoppi",
    "Jaale",
    "Jaani",
    "Jaapo",
    "Jahan",
    "Jahja",
    "Jahje",
    "Jahvet",
    "Jahvetti",
    "Jaime",
    "Jakim",
    "Jakke",
    "Jakov",
    "Jakup",
    "Jalal",
    "Jalava",
    "Jalil",
    "Jalle",
    "Jallu",
    "Jamaal",
    "Jamal",
    "Jameel",
    "Jamel",
    "Jamie",
    "Jamiel",
    "Jamil",
    "Jamin",
    "Jammi",
    "Jammu",
    "Jamppa",
    "Janek",
    "Janiel",
    "Janik",
    "Janiv",
    "Janko",
    "Janne",
    "Jannik",
    "Janno",
    "Jannu",
    "Japhet",
    "Jappe",
    "Jeehu",
    "Jeeli",
    "Jeemi",
    "Jeemil",
    "Jeetu",
    "Jehki",
    "Jekki",
    "Jekku",
    "Jelle",
    "Jemal",
    "Jemil",
    "Jeppe",
    "Jeton",
    "Jilali",
    "Jimmi",
    "Jimmie",
    "Joakim",
    "Joakkim",
    "Joeli",
    "Johan",
    "Johani",
    "Johann",
    "Johanni",
    "Johnathan",
    "Johnnie",
    "Jokke",
    "Jokko",
    "Jolle",
    "Jommi",
    "Jonah",
    "Jonatan",
    "Jonathan",
    "Jonathon",
    "Jonel",
    "Joniel",
    "Jonimatti",
    "Jonne",
    "Jonni",
    "Jonnie",
    "Jonnu",
    "Jonte",
    "Jontte",
    "Jonttu",
    "Jooel",
    "Joona",
    "Joonatan",
    "Joonathan",
    "Jooni",
    "Joonia",
    "Joopi",
    "Joppe",
    "Jotham",
    "Jouka",
    "Joukamo",
    "Jouki",
    "Jouko",
    "Jouna",
    "Jouni",
    "Jovan",
    "Jovian",
    "Jovnna",
    "Juhael",
    "Juhamatti",
    "Juhan",
    "Juhana",
    "Juhani",
    "Juhanna",
    "Juhanni",
    "Juhapekka",
    "Juhomatti",
    "Juhopekka",
    "Juhán",
    "Jukka",
    "Jukke",
    "Julian",
    "Juliano",
    "Julien",
    "Julio",
    "Juljan",
    "Julle",
    "Jumaah",
    "Jumah",
    "Jumale",
    "Junno",
    "Junnu",
    "Juuhan",
    "Kaaleppi",
    "Kaapo",
    "Kaappo",
    "Kaiho",
    "Kaiku",
    "Kaimo",
    "Kaino",
    "Kainpoika",
    "Kainu",
    "Kaipia",
    "Kaipio",
    "Kaito",
    "Kajnpoika",
    "Kalev",
    "Kaleva",
    "Kalevi",
    "Kalevo",
    "Kalle",
    "Kallio",
    "Kalvin",
    "Kamaal",
    "Kamal",
    "Kamau",
    "Kamel",
    "Kamil",
    "Kataja",
    "Kauko",
    "Kauno",
    "Kaveh",
    "Kavin",
    "Keanu",
    "Keijo",
    "Keimo",
    "Keita",
    "Keith",
    "Keivan",
    "Kelpo",
    "Kelvin",
    "Kemal",
    "Kenan",
    "Kenji",
    "Kennet",
    "Kenneth",
    "Kenta",
    "Kenth",
    "Kettil",
    "Keven",
    "Kevin",
    "Khaleel",
    "Khaliil",
    "Khalil",
    "Khanh",
    "Khiem",
    "Kiaan",
    "Kilian",
    "Kille",
    "Killian",
    "Kimani",
    "Kimmo",
    "Kimon",
    "Kimutai",
    "Kinan",
    "Kjell",
    "Klemet",
    "Klemetti",
    "Knuut",
    "Knuutti",
    "Koitto",
    "Kolja",
    "Komlan",
    "Konni",
    "Kontio",
    "Kotivalo",
    "Kouta",
    "Kujtim",
    "Kultimo",
    "Kunto",
    "Kuuno",
    "Kuutti",
    "Laith",
    "Lalli",
    "Lamin",
    "Lamine",
    "Lappi",
    "Launo",
    "Leevi",
    "Leimu",
    "Leino",
    "Leith",
    "Lejon",
    "Lemmi",
    "Lemminki",
    "Lemuel",
    "Lenna",
    "Lenne",
    "Lenni",
    "Lennie",
    "Lenno",
    "Lennon",
    "Lennu",
    "Leone",
    "Leonel",
    "Leonpoika",
    "Levan",
    "Levent",
    "Levente",
    "Levin",
    "Levon",
    "Liekki",
    "Lieto",
    "Liiam",
    "Lionel",
    "Lippo",
    "Litti",
    "Loimu",
    "Lokman",
    "Louie",
    "Lukman",
    "Luuka",
    "Maalik",
    "Mahin",
    "Mahmut",
    "Mahol",
    "Mahti",
    "Maikel",
    "Maininki",
    "Mainio",
    "Maitham",
    "Majok",
    "Makki",
    "Makoto",
    "Malakai",
    "Malakia",
    "Malek",
    "Malik",
    "Malte",
    "Maltti",
    "Malvin",
    "Mamoon",
    "Mamoun",
    "Manjit",
    "Manne",
    "Manni",
    "Manoj",
    "Manolito",
    "Manuel",
    "Manueli",
    "Matan",
    "Mateen",
    "Matei",
    "Matej",
    "Mateo",
    "Matheo",
    "Mathieu",
    "Matin",
    "Matte",
    "Matteo",
    "Matthieu",
    "Matti",
    "Mattia",
    "Matvei",
    "Matvej",
    "Maukka",
    "Mauno",
    "Maunu",
    "Meeko",
    "Mehmet",
    "Mekki",
    "Mekonnen",
    "Melih",
    "Melik",
    "Melvin",
    "Memet",
    "Menno",
    "Metehan",
    "Metin",
    "Mevlüt",
    "Mielo",
    "Mietti",
    "Mihael",
    "Mihai",
    "Mihail",
    "Mihhail",
    "Mihka",
    "Mihkal",
    "Mihkel",
    "Mihkkal",
    "Mihkku",
    "Mihku",
    "Miihkali",
    "Miika",
    "Miikael",
    "Miikail",
    "Miikka",
    "Miikkael",
    "Miikkali",
    "Miikko",
    "Miikku",
    "Miikkula",
    "Miiko",
    "Miiku",
    "Miilo",
    "Mikael",
    "Mikaeli",
    "Mikail",
    "Mikaël",
    "Mikel",
    "Mikhael",
    "Mikhail",
    "Mikka",
    "Mikkal",
    "Mikke",
    "Mikkel",
    "Mikkeli",
    "Mikki",
    "Mikko",
    "Mikla",
    "Miklo",
    "Mikolaj",
    "Mikuel",
    "Milan",
    "Milen",
    "Mileon",
    "Miliam",
    "Milian",
    "Milio",
    "Miljo",
    "Milko",
    "Mille",
    "Milon",
    "Milot",
    "Milovan",
    "Milton",
    "Minato",
    "Mitja",
    "Mitjo",
    "Moalim",
    "Moalin",
    "Mohaimen",
    "Mohan",
    "Montana",
    "Muhamet",
    "Muhammet",
    "Mumin",
    "Muthana",
    "Muthanna",
    "Máhtte",
    "Naatan",
    "Naattan",
    "Naava",
    "Naeem",
    "Naeim",
    "Nahom",
    "Nahuel",
    "Najem",
    "Najim",
    "Nalle",
    "Naman",
    "Nante",
    "Nanto",
    "Nantte",
    "Naoki",
    "Napat",
    "Naphat",
    "Napoleon",
    "Natael",
    "Natan",
    "Natanael",
    "Natanel",
    "Nataniel",
    "Nathan",
    "Nathanael",
    "Nathaniel",
    "Natnael",
    "Naveen",
    "Navin",
    "Neamah",
    "Neemo",
    "Nehat",
    "Nehemia",
    "Nehemiah",
    "Nemanja",
    "Netanel",
    "Nevan",
    "Neville",
    "Nevin",
    "Niall",
    "Nihal",
    "Nihat",
    "Niikka",
    "Niikko",
    "Niiko",
    "Niila",
    "Niilo",
    "Nikan",
    "Nikhil",
    "Nikita",
    "Nikke",
    "Nikki",
    "Nikko",
    "Nikla",
    "Nikoel",
    "Nikola",
    "Nikolaev",
    "Nikolai",
    "Nikolaj",
    "Nikon",
    "Noeli",
    "Nolan",
    "Noman",
    "Nooah",
    "Nooke",
    "Numan",
    "Nuuti",
    "Nuutti",
    "Olakunle",
    "Olalekan",
    "Olavi",
    "Ollie",
    "Ollimatti",
    "Ollipekka",
    "Onnimanni",
    "Onnipekka",
    "Opoku",
    "Otava",
    "Othman",
    "Otieno",
    "Otniel",
    "Otonpoika",
    "Ottoville",
    "Ovllá",
    "Paavali",
    "Paavo",
    "Palle",
    "Paolo",
    "Pauli",
    "Paulino",
    "Paulo",
    "Pauno",
    "Pavel",
    "Pavlo",
    "Peeta",
    "Peeti",
    "Peetja",
    "Peetu",
    "Peikko",
    "Peiman",
    "Peippo",
    "Pekka",
    "Pekki",
    "Pekko",
    "Pelle",
    "Penja",
    "Penjami",
    "Penjamin",
    "Penna",
    "Pentti",
    "Penuel",
    "Peppe",
    "Petja",
    "Petka",
    "Pette",
    "Philip",
    "Philipp",
    "Philippe",
    "Phillip",
    "Pieti",
    "Pietu",
    "Platon",
    "Pluto",
    "Pohto",
    "Poika",
    "Pokko",
    "Ponteva",
    "Pouta",
    "Putte",
    "Taave",
    "Taavetti",
    "Taavi",
    "Tahko",
    "Tahlil",
    "Tahto",
    "Tahvana",
    "Tahvo",
    "Taimo",
    "Taito",
    "Takeo",
    "Talaat",
    "Talal",
    "Talha",
    "Tamim",
    "Tamino",
    "Tammi",
    "Tanel",
    "Taneli",
    "Tapani",
    "Tapio",
    "Taulant",
    "Tauno",
    "Teemu",
    "Teijo",
    "Teiko",
    "Teimo",
    "Teini",
    "Teino",
    "Teivo",
    "Teljo",
    "Telmo",
    "Temitope",
    "Temmo",
    "Tempo",
    "Tenho",
    "Teoman",
    "Teppana",
    "Teppo",
    "Tetteh",
    "Teuvo",
    "Thain",
    "Thana",
    "Thanaphon",
    "Thanh",
    "Theon",
    "Thien",
    "Thilo",
    "Thinh",
    "Thiên",
    "Thuan",
    "Tihon",
    "Tiihon",
    "Tiikka",
    "Tijan",
    "Tijani",
    "Timeo",
    "Timjam",
    "Timjami",
    "Timka",
    "Timmi",
    "Timmie",
    "Timmo",
    "Timon",
    "Timopekka",
    "Timotei",
    "Timppa",
    "Toimi",
    "Toivi",
    "Toivio",
    "Toivo",
    "Tomek",
    "Tomio",
    "Tomme",
    "Tommi",
    "Tommie",
    "Tommo",
    "Tomppa",
    "Toniel",
    "Topia",
    "Totte",
    "Totti",
    "Touho",
    "Touko",
    "Tuhto",
    "Tunna",
    "Tuomma",
    "Tuomo",
    "Tuuka",
    "Tuukka",
    "Tuulo",
    "Ukkopekka",
    "Ukonpoika",
    "Ullah",
    "Untamo",
    "Uolevi",
    "Uthman",
    "Vaalimo",
    "Vaatu",
    "Vaito",
    "Valentin",
    "Valentine",
    "Valentino",
    "Valio",
    "Valle",
    "Vallu",
    "Valon",
    "Valte",
    "Valto",
    "Valton",
    "Valtti",
    "Valtu",
    "Valve",
    "Vante",
    "Vantte",
    "Veeka",
    "Veele",
    "Veeli",
    "Veeni",
    "Veeti",
    "Veetu",
    "Veija",
    "Veijo",
    "Veikka",
    "Veikki",
    "Veikko",
    "Veiko",
    "Veini",
    "Veino",
    "Velho",
    "Velimatti",
    "Velipekka",
    "Veljo",
    "Vello",
    "Vellu",
    "Velmu",
    "Venho",
    "Veniamin",
    "Venjami",
    "Venjamin",
    "Venkata",
    "Venne",
    "Venni",
    "Venno",
    "Vennu",
    "Vento",
    "Veton",
    "Viima",
    "Viimo",
    "Vikke",
    "Vikki",
    "Vikko",
    "Vilhe",
    "Vilhelm",
    "Vilhelmi",
    "Vilhem",
    "Vilho",
    "Viliam",
    "Viljam",
    "Viljami",
    "Viljo",
    "Vilke",
    "Vilkka",
    "Vilkko",
    "Vilkku",
    "Vilko",
    "Ville",
    "Villem",
    "Villi",
    "Villiam",
    "Villjam",
    "Vilmo",
    "Vilpo",
    "Vilppo",
    "Vilppu",
    "Vimme",
    "Vinha",
    "Vinjami",
    "Vinnie",
    "Vitali",
    "Vitalii",
    "Vivek",
    "Voima",
    "Voitto",
    "Volkan",
    "Voltti",
    "Çetin",
])

erikseen_sallitut = set([
])

sallivat_suotimet = [
    lambda n, _: n in erikseen_sallitut,  # erikseen sallitut
]

poissulkevat_suotimet = [
    #lambda n, yleisyys: yleisyys[0] < 20 or yleisyys[0] >= 7200,  # liian harvinaiset ja suositut pois
    lambda n, yleisyys: yleisyys[1] > 3 * yleisyys[0],  # naisia paljon enemmän kuin miehiä
    lambda n, _: len(n) < 5 or len(n) > 9,  # lyhyet ja pitkät pois
    #lambda n, _: n[0].lower() in "hjr",  # Kielletyt alkukirjaimet
    #lambda n, _: n[-1] in konsonantit,  # päättyy konsonanttiin
    lambda n, _: any(c in n.lower() for c in "bcdéfgqwxzyöäå-"),  # kielletyt kirjaimet
    #lambda n, _: any(s in n.lower() for s in ["kk", "ll", "pp", "rn", "rr", "tt"]),  # kielletyt kirjainyhdistelmät
    lambda n, _: n in poissuljetut,
]

filtered = {nimi: yleisyys for nimi, yleisyys in nimet.items()
            if any(f(nimi, yleisyys) for f in sallivat_suotimet)
            or all(not f(nimi, yleisyys) for f in poissulkevat_suotimet)}

def tuple_sum(tuples):
    return tuple(sum(zipped) for zipped in zip(*tuples))
def nimipalveluyleisyyden_minimi_ja_maksimi(nimipalveluyleisyys):
    if nimipalveluyleisyys == "alle 5":
        return 1, 4
    else:
        return int(nimipalveluyleisyys), int(nimipalveluyleisyys)

def muotoile_vaihteluvali(minimi, maksimi):
    if minimi == maksimi:
        return str(minimi)
    else:
        return f"{minimi}-{maksimi}"
def laske_nimen_yleisyys_alkaen_2010(nimipalvelu_data):
    miehet_min, miehet_max = tuple_sum([nimipalveluyleisyyden_minimi_ja_maksimi(d) for d in [nimipalvelu_data[0], nimipalvelu_data[2]]])
    naiset_min, naiset_max = tuple_sum([nimipalveluyleisyyden_minimi_ja_maksimi(d) for d in [nimipalvelu_data[1], nimipalvelu_data[3]]])
    return muotoile_vaihteluvali(miehet_min, miehet_max), muotoile_vaihteluvali(naiset_min, naiset_max)

def hae_nimen_yleisyysdata_alkaen_2010_nimipalvelusta(nimi):
    cache_file_path = f"nimipalvelu_cache/{nimi}"
    if os.path.isfile(cache_file_path):
        with open(cache_file_path) as f:
            return [l for l in f.read().split("\n") if l]
    else:
        data = os.popen(f"curl -s 'https://verkkopalvelu.vrk.fi/nimipalvelu/nimipalvelu_etunimihaku.asp?L=1' --data-raw 'nimi={nimi}&submit2=HAE'|grep -A12 -e '^2010-19' -e '^2020-'|sed -n -e 5p -e 9p -e 19p -e 23p").read()
        with open(cache_file_path, "w") as f:
            f.write(data)
        return hae_nimen_yleisyysdata_alkaen_2010_nimipalvelusta(nimi)

header = f"{'Nimi':10} {'Miehiä':6} {'Naisia':6} {'Miehiä 2010-':>12} {'Naisia 2010-':>12}"
print(header)
print("-" * len(header))
for nimi, (m, n) in sorted(filtered.items()):
    miehia_alkaen_2010, naisia_alkaen_2010 = laske_nimen_yleisyys_alkaen_2010(hae_nimen_yleisyysdata_alkaen_2010_nimipalvelusta(nimi))
    print(f"{nimi:10} {m:6} {n:6} {miehia_alkaen_2010:>12} {naisia_alkaen_2010:>12}")
print(f"Yhteensä {len(filtered)} nimeä")